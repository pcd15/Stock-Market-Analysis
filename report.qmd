---
title: "The Impacts of Inflation and Interest Rates on the Stock Market"
subtitle: "Report"
format: html
editor: visual
execute:
  echo: false
---

```{r message = FALSE}
#|: loading-packages

library(tidyverse)
library(tidymodels)
library(scales)
library(ggplot2)
library(lubridate)
library(dplyr)
```

# Introduction

We want to explore the relationship between interest and inflation rates and the performance of the stock market. In doing so, we hope to determine economic characteristics in which it's beneficial to invest in the stock market, as well as if/when certain companies or sectors perform better in different economic climates. Therefore, we are interested in answering the following questions:

-   How have these rates (inflation and interest) historically impacted the returns of the stock market? How closely has the current performance of the market (the past two years) followed these historical trends?

-   Does the current high-rate economic climate disproportionately affect some companies/sectors more than others? If so, why might this be?

For our historical analysis, we'll utilize a data set that includes yearly averages for the federal funds rate, inflation rate, and the S&P 500's return percentage from 1961 to 2020 in order to examine trends during this time frame. For our current-day analysis, we'll utilize a data set that details the S&P 500's daily performance over the past two years to compare our historical findings with recent trends. Lastly, we have a data set that includes each company in the S&P 500 index, along with their sector and year-to-date performance, which we'll use to examine whether certain companies/sectors have performed better as rates have risen throughout this year.

We believe the overall stock market would be hurt by high inflation and corresponding high interest rates, both because consumers' discretionary incomes drop and because companies are disincentivized from borrowing, due to the higher costs associated with taking out a loan. We expect to see this relationship in our historical analysis and our current-day analysis. Conversely, in times of lower rates, we expect market returns to be higher, on average. Though we expect the stock market as a whole to suffer from high rates, we believe certain sectors of the economy could serve as silver linings for investors' pockets; these industries include: financials, health care, utilities, and consumer staples. We believe these sectors could perform better than the aggregate market because they sell essential goods that consumers must purchase no matter the state of the economy (health care, utilities, and consumer staples). Also, we believe the financials sector will do well because banks are able to charge higher interest rates on their loans (and thus earn greater profits) when interest rates are high.

**Note:** We are using the S&P 500 as a model of the performance of the entire market, and we are using the federal-funds rate, the interest rate at which banks loan to other banks, to model the general trend of all interest rates. We believed these are logical assumptions, as the S&P 500 includes the 500 largest US-based companies (and thus covers a large portion of the total market) and the federal-funds rate generally serves as a benchmark for all other interest rates (because it is indirectly influenced by the Federal Reserve's policies). Also, all of our observations feature the performance of the market (S&P 500) or an individual company in the S&P 500 on a specific day/month/year.

## Part 1: Historical vs. Current Analysis

We decided to look at the S&P 500's Historical Performance in relation to inflation and interest rates, and compare that to data from recent years.

**Sources for Historical Data:**

-   Federal Funds Rate and Inflation Rate: Macrotrends (<https://www.macrotrends.net/2015/fed-funds-rate-historical-chart>)

-   S&P 500 Annual Returns: Slickcharts (https://www.slickcharts.com/sp500/returns)

-   Monthly Statistics (scraped): Official Data (https://www.officialdata.org/us/stocks/s-p-500/1900).

All of these sites collected these data by retrieving the data published publicly on stock exchanges, except for the federal-funds rate--this data was collected from the World Bank. In addition, each of these sites updates their data monthly/yearly (although they could update it daily, as they are collecting live data). Each observation represents a month in a year (between 1961 and 2020) and includes the following variables:

| Variable            | Definition                                                             |
|------------------|------------------------------------------------------|
| year                | year in which observation was recorded                                 |
| month               | month in which observation was recorded                                |
| monthly_return      | total stock market's monthly return                                    |
| year_to_date_return | S&P 500's yearly return                                                |
| mean_fed_funds_rate | mean annual interest rate set by the Federal Reserve                   |
| inflation_rate      | mean annual inflation rate                                             |
| decade              | represents decade in which observation was made                        |
| rate_type           | "low" if both inflation_rate and mean_fed_funds_rate \< 5, else "high" |
| return_type         | "gain" if year_to_date_return \> 0, else "loss                         |

```{r message = FALSE}
#|: loading-historical-data

historical_data <- read_csv("data/historical_data.csv")
```

```{r warning = FALSE, message = FALSE}
#| label: fig-inflation-and-interest-vs-returns
#| fig-cap: "Interest and inflation rates vs. S&P 500 returns"

colors_redux <- c("Inflation" = "blue", "Interest" = "red", "Market Returns" = "darkgreen")

historical_data |>
  ggplot() +
  geom_line(aes(x = year, y = mean_fed_funds_rate, color = "Interest")) +
  geom_line(aes(x = year, y = inflation_rate, color = "Inflation")) +
  geom_line(aes(x = year, y = year_to_date_return, color = "Market Returns")) +
  theme_minimal() +
  labs(
    x = "Year",
    y = "Average Annual Rate (%)",
    color = "Type"
  ) +
  theme(legend.title = element_text(hjust = 0.5)) +
  scale_color_manual(values = colors_redux) +
  scale_color_viridis_d(option = "turbo")
```

Here, we can get an overview of something the old data shows - how stock prices fluctuate with changes in interest and inflation.

**Contextualization for Current Data:** We're analyzing the time period of October 2020 through October 2022. This year, inflation has risen to \~8%, up from \<2% in 2020 and \<5% in 2021. Interest rates have steadily risen in tandem with this increase in inflation. In an attempt to slow down inflation, Federal Reserve has increased the discount rate (the rate at which banks are charged to borrow from the Federal Reserve) from 0.5% in March 2022 to a current rate of 4%, which is the highest it's been since the 2008 recession.

**Source for Current Data:**

-   Investing.com (https://www.investing.com/indices/us-spx-500-historical-data)

Investing.com gets their data from financial-data providers, including stock exchanges and/or directly from market makers (who set stock prices to match supply and demand). The data is collected in real time by monitoring transactions (selling, buying, etc.) executed in the stock market, which correspond to increases/decreases in prices. Each observation represents a different day (between 1 October 2020 and 28 October 2022) and includes the following variables:

| Variable                | Definition                                                           |
|--------------------|----------------------------------------------------|
| date                    | day on which observation was recorded                                |
| price                   | closing daily price for the S&P 500                                  |
| open                    | opening daily price for the S&P 500                                  |
| daily_percentage_change | daily percentage difference between opening and closing prices       |
| daily_diff              | daily numerical difference between opening and closing prices        |
| gain                    | "gain" if daily_diff \> 0 (positive return for the day), else "loss" |

```{r message = FALSE}
#|: loading-current-day-sp500-data-old

sp500_curr <- read_csv("data/sp500_curr_updated.csv")
```

```{r message = FALSE}
#| label: fig-daily-closing-price
#| fig-cap: "Daily closing prices for S&P 500 index by month"

sp500_curr |>
 mutate(
   Date = paste(
     substr(Date, 9, 10), 
     substr(Date, 1, 2),  
     sep = "/"
    )
  ) |>
  group_by(Date) |>
  mutate(
    median_price = median(Price),
    min_price = min(Price),
    max_price = max(Price)
  ) |>
  ggplot(aes(x = Date, y = median_price)) +
  geom_line(group = 1, color = "red") +
  geom_point() + 
  geom_errorbar(aes(ymin = min_price, ymax = max_price), width = 0.2) +
  scale_x_discrete(breaks=c("20/10","21/10", "22/10")) +
  labs(
    x = "Date (year/month)",
    y = "Daily S&P 500 Closing Price"
  ) +
  theme_minimal()
```

We first graphed each day's closing price to determine the trend in closing price over time. We utilized a scatter plot to visualize the data for closing price from 10/01/2020 to 10/28/2022; each point represents the closing price of the S&P 500 index on a particular day, with days grouped by their respective months and years.

## Part 2: Company and Sector Analysis

**Contextualization:** Because of high inflation rates, and rising interest rates, the stock market has taken a major blow this past year. However, some sectors and stocks have been more negatively affected than others. We believe that industries that are considered more essential tend to be less affected by fluctuations in these rates. So how true is this, and how much are both of these categories affected? In this section, we're analyzing data from the beginning of 2022 to the end of October.

**Sources:**

-   Name, Symbol, and Sector: DATA HUB (https://datahub.io/core/s-and-p-500-companies-financials#resource-constituents)

-   Weights (scraped): Slickcharts (<https://www.slickcharts.com/sp500>)

-   Prices and Returns (scraped): Slickcharts (<https://www.slickcharts.com/sp500/performance>)

DATA HUB collected their data from S&P Dow Jones Indices (which, in turn, is collected daily from stock exchanges), and Slickcharts their data directly from the stock exchange. Each observation represents a different company and includes the following variables:

| Variable        | Definition                                                                |
|----------------|-------------------------------------------------------|
| name            | name of company in S&P 500                                                |
| symbol          | ticker symbol used to identify companies on stock exchange                |
| weight          | percentage weighting of company in S&P 500                                |
| original_price  | price of company's stock at beginning of 2022                             |
| current_price   | price of company's stock as of October 2022                               |
| ytd_return_num  | company's year-to-date return percentage, expressed as a number           |
| sector          | company's industry                                                        |
| return category | "gain" if ytd_return_num \> 0 (positive return for the year), else "loss" |

```{r message = FALSE}
#|: loading-current-day-company-and-sector-data

sp500_by_company_and_sector <- read_csv("data/sp500_by_company_and_sector.csv")
```

```{r}
#| label: fig-overall-performance-of-sp500-by-return-type-eda
#| fig-cap: "Number of S&P 500 companies by year-to-date return type"

sp500_by_company_and_sector |> 
  ggplot(aes(x = return_category, fill = return_category)) +
  geom_bar(color = "black") +
  geom_text(aes(label = after_stat(count)), color = "white", vjust = 2, stat = "count") + 
  labs(
    x = "Return Type",
    y = "Number of Companies"
  ) +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_viridis_d(option = "turbo")
```

To get a glimpse of what we are looking at, our first bar graph shows the total number of stocks in the S&P 500 that saw a decrease, and those that saw an increase.

```{r}
#| label: fig-essential-vs-nonessential-industries
#| fig-cap: "Return distribution of S&P 500 companies by industry type"

sp500_by_company_and_sector |>
  mutate(
    isEssential = case_when(
      sector == "Utilities" | sector == "Energy" | sector == "Consumer Staples" ~ "Essential",
      TRUE ~ "Nonessential"
    )
  ) |>
  ggplot(aes(y = ytd_return_num, x = isEssential, fill = isEssential)) +
  geom_violin(show.legend = FALSE) +
  labs(
     y = "YTD Return %",
     x = "Type of Sector",
     fill = "cc"
  ) +
  theme_minimal() +
  scale_fill_viridis_d(option = "turbo")
```

This graph takes into account the concept of essential and nonessential categories. We classify essential industries as Consumer Staples, Utilities, and Energy, since consumer staples includes food, utilities has electricity, and energy has the materials we need for electricity and more. We would hypothesize that the essential category of industries would not be as affected as the nonessential category, because regardless of how the market is, people need to spend money on the things that will keep them alive. We look to see if there is a quantifiable difference between which of these two larger groups for sectors performed better. To do this, a violin plot is made where the category is on the x axis, and returns are on the y axis.

# Methodology:

## Part 1:

Then, we analyzed the relationship between rates and average yearly returns of the stock market for the same period using more line graphs.

```{r}
#| label: tbl-best-and-worst-ten-years-of-returns
#| tbl-cap: ["Ten years with highest annual S&P 500 returns", "Ten years with lowest annual S&P 500 returns"]
#| layout-ncol: 2

historical_data_best <- historical_data |> 
  rename(mean_funds_rt = mean_fed_funds_rate,
         ytd_ret = year_to_date_return) |>
  distinct(year, mean_funds_rt, inflation_rate, ytd_ret) |>
  arrange(desc(ytd_ret)) |>
  slice_head(n = 10) |> 
  relocate(year, ytd_ret) |>
  knitr::kable()

historical_data_best

historical_data_worst <- historical_data |> 
    rename(mean_funds_rt = mean_fed_funds_rate,
         ytd_ret = year_to_date_return) |>
  distinct(year, mean_funds_rt, inflation_rate, ytd_ret) |>
  arrange(ytd_ret) |>
  slice_head(n = 10) |> 
  relocate(year, ytd_ret) |> 
  knitr::kable()

historical_data_worst
```

Next, we determined the best and worst 10 years of performance for the stock market by sorting by year_to_date_return and arranging in ascending (worst) and descending (best) order, in order to examine the years individually rather than as a trend across time.

```{r}
#|: prop-gains-by-rate-type

historical_data_by_rate_type <- historical_data |>
  group_by(year) |>
  mutate(
    rate_type = if_else(mean_fed_funds_rate < 5 & inflation_rate < 5, "low", "high"),
    return_type = if_else(year_to_date_return > 0, "gain", "loss")
  ) |>
  ungroup()
```

To evaluate whether our hypothesis that companies generally perform better in low-rate environments is true (for this test, a year is required to have had both an interest and inflation rate below 5% in order to be considered a low-rate environment), we performed a hypothesis test:

$H_0$: $p_1 - p_2 = 0$

$H_A$: $p_1 - p_2 > 0$,

where $p_1$ is the proportion of companies who had positive annual returns in low-rate environments and $p_2$ is the proportion of companies who had positive annual returns in high-rate environments.

```{r warning = FALSE}
#|: hypothesis-test-for-prop-returns-by-rate-type

null_dist <- historical_data_by_rate_type |>
  specify(return_type ~ rate_type, success = "gain") |>
  hypothesize(null = "independence") |>
  generate(5000, type = "permute") |>
  calculate(stat = "diff in props", order = c("low", "high"))

point_estimate <- historical_data_by_rate_type |>
  specify(return_type ~ rate_type, success = "gain") |>
  calculate(stat = "diff in props", order = c("low", "high"))

p_value <- null_dist |>
  get_p_value(obs_stat = point_estimate, direction = "right")
```

After conducting our hypothesis test with a 5% significance level, we found our p-value to be 0.0002. Since the p-value is less than our significance level, we reject the null hypothesis in favor of the alternative hypothesis. The data provide convincing evidence that the mean year-to-date return for companies in essential industries is greater than that of companies in nonessential industries.

```{r}
#|: creating-df-of-averages-of-returns-and-rates-by-decade
# excluded 2020 because it's not a whole decade

historical_data_decade <- historical_data |>
  filter(decade != "2020") |>
  group_by(decade) |>
  summarize(
    mean_return = mean(year_to_date_return),
    mean_interest = mean(mean_fed_funds_rate),
    mean_inflation = mean(inflation_rate)
  ) |>
  arrange(desc(mean_return))
```

## Part 2: By Sector Analysis

Next, we will observe the best and worst performing stocks. We will do this by arranging by arranging year-to-date returns in ascending and descending order, then displaying the top five best and worst in a tibble, along with some key identifying factors.

```{r}
#| label: tbl-five-companies-with-highest-and-lowest-returns
#| tbl-cap: ["Five companies with highest year-to-date returns", "Five companies with lowest year-to-date returns"]
#| layout-ncol: 2

sp500_by_company_and_sector |>
  rename(ytd_ret = ytd_return_num) |>
  arrange(desc(ytd_ret)) |>
  slice_head(n = 5) |>
  select(name, symbol, ytd_ret, sector) |> 
  knitr::kable()

sp500_by_company_and_sector |>
  rename(ytd_ret = ytd_return_num) |>
  arrange(ytd_ret) |>
  slice_head(n = 5) |>
  select(name, symbol, ytd_ret, sector) |>
  knitr::kable()
```

For our next graph, we get to see exactly what the increase/decrease range was for each sector. So we made box plots for each sector, with hopes to see who had the highest and lowest median increases, who had the highest and lowest variation, and also who had the highest and lowest maximums and minimums. The box plots were made with sectors across the y, and returns along the x. This information will allow us to gain more understanding of the most stable sectors, as well as the most unaffected ones.

```{r}
#| label: fig-sector-performance
#| fig-cap: "Year-to-date performance of S&P 500 across sectors"

sp500_by_company_and_sector |>
  mutate(
    sector = fct_relevel(
      sector, 
      "Energy",
      "Consumer Staples",
      "Utilities",
      "Financials",
      "Industrials",
      "Health Care",
      "Materials",
      "Information Technology",
      "Communication Services",
      "Consumer Discretionary",
      "Real Estate"
    ),
    sector = fct_rev(sector)
  ) |>
  ggplot(aes(x = ytd_return_num, y = sector, fill = sector)) +
  geom_boxplot(show.legend = FALSE) +
  labs(
     x = "YTD Return %",
     y = "Sector",
     fill = "cc"
  ) +
  theme_minimal() + 
  scale_fill_viridis_d(option = "turbo")
```

```{r}
#|: mean-returns-for-essentiality-category

sp500_by_company_and_sector_ess <- sp500_by_company_and_sector |>
  mutate(
    isEssential = case_when(
      sector == "Utilities" | 
      sector == "Energy" | 
      sector == "Consumer Staples" ~ "Essential",
      TRUE ~ "Nonessential"
    )
  )
```

To support our belief that companies in essential industries have performed better this past year than those in nonessential sectors, we'll perform a hypothesis test:

$H_0$: $\mu_1 - \mu_2 = 0$

$H_A$: $\mu_1 - \mu_2 > 0$,

where $\mu_1$ is the mean year-to-date return for companies in essential sectors and $\mu_2$ is the mean year-to-date return for companies in nonessential sectors.

```{r warning = FALSE}
#|: hypothesis-test-for-ess-vs-noness-sectors

null_dist2 <- sp500_by_company_and_sector_ess |>
  specify(ytd_return_num ~ isEssential) |>
  hypothesize(null = "independence") |>
  generate(5000, type = "permute") |>
  calculate(stat = "diff in means", order = c("Essential", "Nonessential"))

point_estimate2 <- sp500_by_company_and_sector_ess |>
  specify(ytd_return_num ~ isEssential) |>
  calculate(stat = "diff in means", order = c("Essential", "Nonessential"))

p_value2 <- null_dist |>
  get_p_value(obs_stat = point_estimate2, direction = "right")
```

After conducting our hypothesis test with a 5% significance level, we found our p-value to be approximately 0. Since the p-value is less than our significance level, we reject the null hypothesis in favor of the alternative hypothesis. The data provide convincing evidence that the mean year-to-date return for companies in essential industries is greater than that of companies in nonessential industries.

# Results:

pt1:

As you can see in @fig-inflation-vs-interest-vs-returns, inflation and interest rates are very closely related (especially prior to 2000), with interest and inflation peaking and dipping at similar times. This trend makes sense, as the Federal Reserve tends to raise interest rates when inflation rises, in an attempt to slow the economy down. (This is why the Federal Reserve is raising interest rates now.) @fig-inflation-and-interest-vs-returns also shows that market returns are extremely volatile and (at least according to this graph) don't seem to depend on either interest or inflation, contrary to our hypothesis. 

@tbl-best-ten-years-of-returns show that almost all of the best years for S&P 500 returns feature either a low interest or inflation rate (\<5%), with many having both low interest and inflation rates. Noticeable outliers include 1980, whose rates were both over 13%, and 1975, whose interest rate was almost 6% and inflation 9%. This trend of high returns correlating with lower rates does support our hypothesis. On the other hand, we expected many of the worst years for market returns to have high rates; surprisingly, this was not the case for about half of the worst years, as shown in @tbl-worst-ten-years-of-returns. Though some years did support our hypothesis, including 1974, 1973, 1969, and 1977, the others featured surprisingly low rates. We suspect that these unanticipated poor performance of the stock market during times of low rates could possibly be explained by recessions occurring during these years; in recessionary gaps, inflation tends to be lower because the economy has slowed significantly, and interest rates tend to be low as well in an attempt to re-stimulate the economy by encouraging borrowing.

In @fig-daily-closing-price, we can see that the median monthly closing prices for the S&P 500 follow a generally positive trend from October 2020 to December 2021/January 2022, where they peak for the two-year period, and then begin to generally decline through October 2022. Each month had a wide range of closing prices that we can observe from the range of the heights of closing price data points each month. Some months have a range of approximately \$250 (e.g., August 2022), while others have a range of approximately \$750 (e.g., February 2021). This trend can possibly be explained by the very low rates characteristic of the Covid-19 era--the interest rate during the period prior to February 2022 was at a steady 0.25%. As soon as the Federal Reserve hiked rates in March 2022 to 0.5% (to combat rising inflation that had begun in late 2022), however, daily closing prices began to fall. This reflects our findings in our historical analysis and supports our hypothesis that rising rates generally correlate with a decrease in stock prices.

pt2:

From @fig-overall-performance-of-sp500-by-return-type, it can be seen that over 80% of the companies in the S&P 500 have featured falling stock prices over the past year. In @tbl-ten-companies-with-highest-returns and @tbl-ten-companies-with-lowest-returns, we can see that a lot of the stocks that have similar performance also share a sector--the top high-performing stocks exclusively belong to companies in the energy and utility sectors, while consumer staples, communication services, and information technology seem to be the hardest-hit sectors of the low-performing stocks.

Using @fig-sector-performance, we can clearly see that the lowest industries are: Consumer Discretionary, IT, and Consumer Services. The highest are: Energy, Utilities, and Consumer Staples. Health care, along with some of the lower ones, have high variability. As evidenced in @fig-essential-vs-nonessential-industries, there is a visible difference in the essential and non-essential industries. Essential industries have a higher density of values above zero and feature higher maximums and lower minimums, as well as more clumped up data around a neutral zone. Essential companies' stocks lost less of their value and look as if they are more consistent.

# Discussion:

conc1:

**Conclusion:** Our initial hypothesis was partially correct. It seems that higher returns in the stock market generally correlate with lower interest and inflation rates, but years with lower returns can't be explained as neatly, at least with the data we're using. A potential confounding variable could be whether our economy was experiencing a recession during that year, as recessions sometimes create environments where returns in the stock market are poor even in times of low rates. Given this, it was difficult to apply any predictions to our current-day analysis, since the market currently features very low (mostly negative) returns. However, our findings in the current-day analysis also support our initial hypothesis that the performance of the stock market would be hurt by higher interest and inflation rates; as @fig-daily-closing-price depicts, the daily closing price of the S&P 500 has fallen significantly over the past year following the rapid increase in inflation and interest rates.

conc2:

**Conclusion:** Our initial hypothesis states that "essential industries\"--Financials, Energy, Utilities and Consumer Staples--will not be as affected, despite the fact that the stock market suffers from high rates as a whole. The data collected substantially supports this hypothesis. @fig-overall-performance-of-sp500-by-return-type shows that there is a general decrease in stock prices (80%), but within that, we see how the decrease is explained by the variation in performance by sector. @fig-sector-performance explains these variations, showing how industries such as Consumer Discretionary, IT, Real Estate, and Consumer Services are some of the worst-performing sectors, while Energy is by far the highest performing (it\'s the only sector with a positive median year-to-date return), followed by Consumer Staples, Utilities, and Financials. Additionally, there is a lot of variability in each sector, which, by grouping into "essential" vs. "non-essential" industry, is addressed, and demonstrates how essential industries are generally affected less, as they have a higher density of values above zero, as well as higher maximums.

overarching:

Our research aimed to explore the relationship between interest and inflation rates and the performance of the stock market to showcase beneficial investment decisions in the context of today's market and fluctuating economic climates. We hypothesized that the overall stock market would be hurt by high inflation/interest rates and that certain sectors of the economy would be less affected than others in these circumstances. Overall, our data has supported our hypotheses to a fair extent. From our historical and current-day analyses, we can conclude that higher returns in the stock market generally occur in times of lower interest and inflation rates; through our evaluation of sector return differences, we conclude that essential (survival-focused) industries will perform better relative to other sectors when the rest of the market is suffering. However, our analyses were somewhat limited by confounding variables, including volatile economic climates and recessionary pressures; e.g., it can be difficult to determine when stock market will feature lower returns, as shown in our historical analysis.

# Appendix

```{r warning = FALSE}
#|: hypo-test1-vis

null_dist |>
  visualize() +
  shade_p_value(obs_stat = point_estimate, direction = "right") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))
```

```{r warning = FALSE}
#|: hypo-test2-vis

null_dist2 |>
  visualize() +
  shade_p_value(obs_stat = point_estimate2, direction = "right") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))
```
